@page "/settings"
@* Preferences not available in MAUI Blazor WebView - using in-memory storage instead *@

<div class="rockefeller-settings-container">
    <div class="rockefeller-settings-header">
        <h1 class="rockefeller-title">
            <MudIcon Icon="@Icons.Material.Filled.Settings" Size="Size.Large" style="margin-right: 16px;" />
            Rockefeller-AI Configuration
        </h1>
        <p class="rockefeller-subtitle-text">Configure your trading system, AI engine, and risk management preferences</p>
    </div>
    
    <!-- Binance API Configuration -->
    <div class="rockefeller-settings-card">
        <div class="rockefeller-settings-card-header">
            <MudIcon Icon="@Icons.Material.Filled.Key" Size="Size.Small" style="margin-right: 8px; color: var(--rockefeller-accent);" />
            <h2 class="rockefeller-settings-card-title">Binance API Configuration</h2>
        </div>
        <p class="rockefeller-settings-card-description">
            Configure your Binance API credentials for trading operations. Keep these secure and never share them.
        </p>
        
        <MudGrid>
            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="apiKey" 
                             Label="API Key" 
                             Variant="Variant.Outlined" 
                             Class="rockefeller-settings-input"
                             InputType="InputType.Password"
                             AdornmentIcon="@Icons.Material.Filled.Key"
                             Adornment="Adornment.Start" />
            </MudItem>
            
            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="secretKey" 
                             Label="Secret Key" 
                             Variant="Variant.Outlined" 
                             Class="rockefeller-settings-input"
                             InputType="InputType.Password"
                             AdornmentIcon="@Icons.Material.Filled.Lock"
                             Adornment="Adornment.Start" />
            </MudItem>
        </MudGrid>
        
        <MudGrid>
            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="testnetUrl" 
                             Label="Testnet URL (Optional)" 
                             Variant="Variant.Outlined" 
                             Class="rockefeller-settings-input"
                             AdornmentIcon="@Icons.Material.Filled.Link"
                             Adornment="Adornment.Start"
                             Placeholder="https://testnet.binance.vision" />
            </MudItem>
            
            <MudItem xs="12" md="6">
                <MudSelect @bind-Value="environment" 
                           Label="Environment" 
                           Variant="Variant.Outlined" 
                           Class="rockefeller-settings-input"
                           AdornmentIcon="@Icons.Material.Filled.Cloud"
                           Adornment="Adornment.Start">
                    <MudSelectItem Value="@TradingEnvironment.Live">Live Trading</MudSelectItem>
                    <MudSelectItem Value="@TradingEnvironment.Testnet">Testnet</MudSelectItem>
                </MudSelect>
            </MudItem>
        </MudGrid>
        
        <div class="rockefeller-settings-actions">
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Primary" 
                       OnClick="SaveApiSettings"
                       StartIcon="@Icons.Material.Filled.Save"
                       Class="rockefeller-btn-primary rockefeller-btn-lg">
                Save Settings
            </MudButton>
            
            <MudButton Variant="Variant.Outlined" 
                       Color="Color.Secondary" 
                       OnClick="TestConnection"
                       StartIcon="@Icons.Material.Filled.Wifi"
                       Class="rockefeller-btn-outline rockefeller-btn-lg">
                Test Connection
            </MudButton>
            
            <MudButton Variant="Variant.Outlined" 
                       Color="Color.Error" 
                       OnClick="ClearSettings"
                       StartIcon="@Icons.Material.Filled.Clear"
                       Class="rockefeller-btn-outline rockefeller-btn-lg">
                Clear Settings
            </MudButton>
        </div>
    </div>
    
    <!-- AI Configuration -->
    <div class="rockefeller-settings-card">
        <div class="rockefeller-settings-card-header">
            <MudIcon Icon="@Icons.Material.Filled.Psychology" Size="Size.Small" style="margin-right: 8px; color: var(--rockefeller-info);" />
            <h2 class="rockefeller-settings-card-title">AI Engine Settings</h2>
        </div>
        <p class="rockefeller-settings-card-description">
            Configure the AI analysis engine for news sentiment, social media monitoring, and trading signals.
        </p>
        
        <MudGrid>
            <MudItem xs="12" md="6">
                <MudSelect @bind-Value="aiConfidenceThreshold" 
                           Label="Minimum AI Confidence" 
                           Variant="Variant.Outlined" 
                           Class="rockefeller-settings-input"
                           AdornmentIcon="@Icons.Material.Filled.Psychology"
                           Adornment="Adornment.Start">
                    <MudSelectItem Value="@(60)">60% - Conservative</MudSelectItem>
                    <MudSelectItem Value="@(70)">70% - Moderate</MudSelectItem>
                    <MudSelectItem Value="@(80)">80% - Aggressive</MudSelectItem>
                    <MudSelectItem Value="@(90)">90% - Very Aggressive</MudSelectItem>
                </MudSelect>
            </MudItem>
            
            <MudItem xs="12" md="6">
                <MudSelect @bind-Value="aiAnalysisSpeed" 
                           Label="Analysis Speed" 
                           Variant="Variant.Outlined" 
                           Class="rockefeller-settings-input"
                           AdornmentIcon="@Icons.Material.Filled.Speed"
                           Adornment="Adornment.Start">
                    <MudSelectItem Value="@AnalysisSpeed.Fast">Fast (5 min intervals)</MudSelectItem>
                    <MudSelectItem Value="@AnalysisSpeed.Medium">Medium (15 min intervals)</MudSelectItem>
                    <MudSelectItem Value="@AnalysisSpeed.Slow">Slow (30 min intervals)</MudSelectItem>
                </MudSelect>
            </MudItem>
        </MudGrid>
        
        <div class="rockefeller-settings-checkboxes">
            <MudCheckBox @bind-Value="enableNewsAnalysis" 
                         Label="News Sentiment Analysis" 
                         Color="Color.Primary"
                         Class="rockefeller-settings-checkbox" />
            
            <MudCheckBox @bind-Value="enableSocialMediaAnalysis" 
                         Label="Social Media Monitoring" 
                         Color="Color.Primary"
                         Class="rockefeller-settings-checkbox" />
            
            <MudCheckBox @bind-Value="enableTechnicalAnalysis" 
                         Label="Technical Indicator Analysis" 
                         Color="Color.Primary"
                         Class="rockefeller-settings-checkbox" />
            
            <MudCheckBox @bind-Value="enableAutoTrading" 
                         Label="Automated Trading" 
                         Color="Color.Primary"
                         Class="rockefeller-settings-checkbox" />
        </div>
        
        <div class="rockefeller-settings-actions">
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Primary" 
                       OnClick="SaveAISettings"
                       StartIcon="@Icons.Material.Filled.Save"
                       Class="rockefeller-btn-primary rockefeller-btn-lg">
                Save AI Settings
            </MudButton>
        </div>
    </div>
    
    <!-- Risk Management -->
    <div class="rockefeller-settings-card">
        <div class="rockefeller-settings-card-header">
            <MudIcon Icon="@Icons.Material.Filled.Security" Size="Size.Small" style="margin-right: 8px; color: var(--rockefeller-warning);" />
            <h2 class="rockefeller-settings-card-title">Risk Management</h2>
        </div>
        <p class="rockefeller-settings-card-description">
            Configure safety measures and circuit breakers to protect your portfolio.
        </p>
        
        <MudGrid>
            <MudItem xs="12" md="6">
                <MudNumericField T="decimal" @bind-Value="dailyLossLimit" 
                                 Label="Daily Loss Limit ($)" 
                                 Variant="Variant.Outlined" 
                                 Class="rockefeller-settings-input"
                                 Min="100m" Max="10000m" Step="100m"
                                 AdornmentIcon="@Icons.Material.Filled.MoneyOff"
                                 Adornment="Adornment.Start" />
            </MudItem>
            
            <MudItem xs="12" md="6">
                <MudNumericField T="decimal" @bind-Value="maxPositionSize" 
                                 Label="Max Position Size (%)" 
                                 Variant="Variant.Outlined" 
                                 Class="rockefeller-settings-input"
                                 Min="1m" Max="50m" Step="1m"
                                 AdornmentIcon="@Icons.Material.Filled.PieChart"
                                 Adornment="Adornment.Start" />
            </MudItem>
        </MudGrid>
        
        <div class="rockefeller-settings-checkboxes">
            <MudCheckBox @bind-Value="enableCircuitBreaker" 
                         Label="Enable Circuit Breaker" 
                         Color="Color.Primary"
                         Class="rockefeller-settings-checkbox" />
            
            <MudCheckBox @bind-Value="enableAuditLogging" 
                         Label="Enable Audit Logging" 
                         Color="Color.Primary"
                         Class="rockefeller-settings-checkbox" />
        </div>
        
        <div class="rockefeller-settings-actions">
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Primary" 
                       OnClick="SaveRiskSettings"
                       StartIcon="@Icons.Material.Filled.Save"
                       Class="rockefeller-btn-primary rockefeller-btn-lg">
                Save Risk Settings
            </MudButton>
        </div>
    </div>
    
    <!-- Trading Preferences -->
    <div class="rockefeller-settings-card">
        <div class="rockefeller-settings-card-header">
            <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Size="Size.Small" style="margin-right: 8px; color: var(--rockefeller-success);" />
            <h2 class="rockefeller-settings-card-title">Trading Preferences</h2>
        </div>
        
        <MudGrid>
            <MudItem xs="12" md="6">
                <MudNumericField T="decimal" @bind-Value="defaultPositionSize" 
                                 Label="Default Position Size (%)" 
                                 Variant="Variant.Outlined" 
                                 Class="rockefeller-settings-input"
                                 Min="0.1m" Max="100m" Step="0.1m"
                                 AdornmentIcon="@Icons.Material.Filled.PieChart"
                                 Adornment="Adornment.Start" />
            </MudItem>
            
            <MudItem xs="12" md="6">
                <MudNumericField T="decimal" @bind-Value="stopLossPercentage" 
                                 Label="Default Stop Loss (%)" 
                                 Variant="Variant.Outlined" 
                                 Class="rockefeller-settings-input"
                                 Min="0.1m" Max="50m" Step="0.1m"
                                 AdornmentIcon="@Icons.Material.Filled.Stop"
                                 Adornment="Adornment.Start" />
            </MudItem>
        </MudGrid>
        
        <MudGrid>
            <MudItem xs="12" md="6">
                <MudNumericField T="decimal" @bind-Value="takeProfitPercentage" 
                                 Label="Default Take Profit (%)" 
                                 Variant="Variant.Outlined" 
                                 Class="rockefeller-settings-input"
                                 Min="0.1m" Max="200m" Step="0.1m"
                                 AdornmentIcon="@Icons.Material.Filled.TrendingUp"
                                 Adornment="Adornment.Start" />
            </MudItem>
            
            <MudItem xs="12" md="6">
                <MudSelect @bind-Value="riskLevel" 
                           Label="Risk Level" 
                           Variant="Variant.Outlined" 
                           Class="rockefeller-settings-input"
                           AdornmentIcon="@Icons.Material.Filled.Security"
                           Adornment="Adornment.Start">
                    <MudSelectItem Value="@RiskLevel.Conservative">Conservative</MudSelectItem>
                    <MudSelectItem Value="@RiskLevel.Moderate">Moderate</MudSelectItem>
                    <MudSelectItem Value="@RiskLevel.Aggressive">Aggressive</MudSelectItem>
                </MudSelect>
            </MudItem>
        </MudGrid>
        
        <div class="rockefeller-settings-actions">
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Primary" 
                       OnClick="@SaveTradingPreferences"
                       StartIcon="@Icons.Material.Filled.Save"
                       Class="rockefeller-btn-primary rockefeller-btn-lg">
                Save Trading Preferences
            </MudButton>
        </div>
    </div>
    
    <!-- Notifications -->
    <div class="rockefeller-settings-card">
        <div class="rockefeller-settings-card-header">
            <MudIcon Icon="@Icons.Material.Filled.Notifications" Size="Size.Small" style="margin-right: 8px; color: var(--rockefeller-accent);" />
            <h2 class="rockefeller-settings-card-title">Notifications</h2>
        </div>
        
        <div class="rockefeller-settings-checkboxes">
            <MudCheckBox @bind-Value="emailNotifications" 
                         Label="Email Notifications" 
                         Color="Color.Primary"
                         Class="rockefeller-settings-checkbox" />
            
            <MudCheckBox @bind-Value="pushNotifications" 
                         Label="Push Notifications" 
                         Color="Color.Primary"
                         Class="rockefeller-settings-checkbox" />
            
            <MudCheckBox @bind-Value="tradeAlerts" 
                         Label="Trade Alerts" 
                         Color="Color.Primary"
                         Class="rockefeller-settings-checkbox" />
            
            <MudCheckBox @bind-Value="performanceReports" 
                         Label="Performance Reports" 
                         Color="Color.Primary"
                         Class="rockefeller-settings-checkbox" />
        </div>
        
        <div class="rockefeller-settings-actions">
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Primary" 
                       OnClick="@SaveNotificationSettings"
                       StartIcon="@Icons.Material.Filled.Save"
                       Class="rockefeller-btn-primary rockefeller-btn-lg">
                Save Notification Settings
            </MudButton>
        </div>
    </div>
    
    <!-- Status Messages -->
    @if (!string.IsNullOrEmpty(statusMessage))
    {
        <div class="rockefeller-settings-status rockefeller-settings-status-@(statusSeverity == Severity.Success ? "success" : statusSeverity == Severity.Warning ? "warning" : statusSeverity == Severity.Error ? "danger" : "info")">
            <MudIcon Icon="@(statusSeverity == Severity.Success ? Icons.Material.Filled.CheckCircle : statusSeverity == Severity.Warning ? Icons.Material.Filled.Warning : statusSeverity == Severity.Error ? Icons.Material.Filled.Error : Icons.Material.Filled.Info)" Size="Size.Small" style="margin-right: 8px;" />
            @statusMessage
        </div>
    }
</div>

@code {
    // In-memory storage for preferences (since Preferences is not available in MAUI Blazor WebView)
    private static readonly Dictionary<string, object> _preferences = new();
    
    // Enums for better type safety
    public enum TradingEnvironment
    {
        Live,
        Testnet
    }
    
    public enum AnalysisSpeed
    {
        Fast,
        Medium,
        Slow
    }
    
    public enum RiskLevel
    {
        Conservative,
        Moderate,
        Aggressive
    }
    
    public enum Severity
    {
        Info,
        Success,
        Warning,
        Error
    }

    // API Settings
    private string apiKey = string.Empty;
    private string secretKey = string.Empty;
    private string testnetUrl = string.Empty;
    private TradingEnvironment environment = TradingEnvironment.Live;
    
    // AI Configuration
    private int aiConfidenceThreshold = 70;
    private AnalysisSpeed aiAnalysisSpeed = AnalysisSpeed.Medium;
    private bool enableNewsAnalysis = true;
    private bool enableSocialMediaAnalysis = true;
    private bool enableTechnicalAnalysis = true;
    private bool enableAutoTrading;
    
    // Risk Management
    private decimal dailyLossLimit = 1000m;
    private decimal maxPositionSize = 10m;
    private bool enableCircuitBreaker = true;
    private bool enableAuditLogging = true;
    
    // Trading Preferences
    private decimal defaultPositionSize = 5.0m;
    private decimal stopLossPercentage = 2.0m;
    private decimal takeProfitPercentage = 6.0m;
    private RiskLevel riskLevel = RiskLevel.Moderate;
    
    // Notifications
    private bool emailNotifications = true;
    private bool pushNotifications = true;
    private bool tradeAlerts = true;
    private bool performanceReports;
    
    // Status
    private string statusMessage = string.Empty;
    private Severity statusSeverity = Severity.Info;
    
    protected override void OnInitialized()
    {
        LoadSettings();
    }
    
    // Helper methods to replace Preferences.Get/Set with in-memory storage
    private T GetPreference<T>(string key, T defaultValue)
    {
        if (_preferences.TryGetValue(key, out var value) && value is T typedValue)
        {
            return typedValue;
        }
        return defaultValue;
    }
    
    private void SetPreference<T>(string key, T value)
    {
        _preferences[key] = value!;
    }
    
    private void RemovePreference(string key)
    {
        _preferences.Remove(key);
    }
    
    private void LoadSettings()
    {
        try
        {
            // Load API Settings
            apiKey = GetPreference("binance_api_key", string.Empty);
            secretKey = GetPreference("binance_secret_key", string.Empty);
            testnetUrl = GetPreference("binance_testnet_url", string.Empty);
            environment = GetPreference("binance_environment", TradingEnvironment.Live);
            
            // Load AI Configuration
            aiConfidenceThreshold = GetPreference("ai_confidence_threshold", 70);
            aiAnalysisSpeed = GetPreference("ai_analysis_speed", AnalysisSpeed.Medium);
            enableNewsAnalysis = GetPreference("ai_news_analysis", true);
            enableSocialMediaAnalysis = GetPreference("ai_social_media_analysis", true);
            enableTechnicalAnalysis = GetPreference("ai_technical_analysis", true);
            enableAutoTrading = GetPreference("ai_auto_trading", false);
            
            // Load Risk Management Settings
            dailyLossLimit = GetPreference("risk_daily_loss_limit", 1000.0m);
            maxPositionSize = GetPreference("risk_max_position_size", 10.0m);
            enableCircuitBreaker = GetPreference("risk_circuit_breaker", true);
            enableAuditLogging = GetPreference("risk_audit_logging", true);
            
            // Load Trading Preferences
            defaultPositionSize = GetPreference("trading_position_size", 5.0m);
            stopLossPercentage = GetPreference("trading_stop_loss", 2.0m);
            takeProfitPercentage = GetPreference("trading_take_profit", 6.0m);
            riskLevel = GetPreference("trading_risk_level", RiskLevel.Moderate);
            
            // Load Notification Settings
            emailNotifications = GetPreference("notifications_email", true);
            pushNotifications = GetPreference("notifications_push", true);
            tradeAlerts = GetPreference("notifications_trade_alerts", true);
            performanceReports = GetPreference("notifications_performance_reports", false);
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error loading settings: {ex.Message}");
            // Settings will remain at their default values if loading fails
        }
    }
    
    private void SaveApiSettings()
    {
        try
        {
            SetPreference("binance_api_key", apiKey);
            SetPreference("binance_secret_key", secretKey);
            SetPreference("binance_testnet_url", testnetUrl);
            SetPreference("binance_environment", environment);
            
            ShowStatus("API settings saved successfully!", Severity.Success);
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error saving API settings: {ex.Message}");
            ShowStatus("Error saving API settings.", Severity.Error);
        }
    }
    
    private void SaveAISettings()
    {
        try
        {
            SetPreference("ai_confidence_threshold", aiConfidenceThreshold);
            SetPreference("ai_analysis_speed", aiAnalysisSpeed);
            SetPreference("ai_news_analysis", enableNewsAnalysis);
            SetPreference("ai_social_media_analysis", enableSocialMediaAnalysis);
            SetPreference("ai_technical_analysis", enableTechnicalAnalysis);
            SetPreference("ai_auto_trading", enableAutoTrading);
            
            ShowStatus("AI settings saved successfully!", Severity.Success);
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error saving AI settings: {ex.Message}");
            ShowStatus("Error saving AI settings.", Severity.Error);
        }
    }
    
    private void SaveRiskSettings()
    {
        try
        {
            SetPreference("risk_daily_loss_limit", dailyLossLimit);
            SetPreference("risk_max_position_size", maxPositionSize);
            SetPreference("risk_circuit_breaker", enableCircuitBreaker);
            SetPreference("risk_audit_logging", enableAuditLogging);
            
            ShowStatus("Risk management settings saved successfully!", Severity.Success);
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error saving risk settings: {ex.Message}");
            ShowStatus("Error saving risk settings.", Severity.Error);
        }
    }
    
    private void SaveTradingPreferences()
    {
        try
        {
            SetPreference("trading_position_size", defaultPositionSize);
            SetPreference("trading_stop_loss", stopLossPercentage);
            SetPreference("trading_take_profit", takeProfitPercentage);
            SetPreference("trading_risk_level", riskLevel);
            
            ShowStatus("Trading preferences saved successfully!", Severity.Success);
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error saving trading preferences: {ex.Message}");
            ShowStatus("Error saving trading preferences.", Severity.Error);
        }
    }
    
    private void SaveNotificationSettings()
    {
        try
        {
            SetPreference("notifications_email", emailNotifications);
            SetPreference("notifications_push", pushNotifications);
            SetPreference("notifications_trade_alerts", tradeAlerts);
            SetPreference("notifications_performance_reports", performanceReports);
            
            ShowStatus("Notification settings saved successfully!", Severity.Success);
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error saving notification settings: {ex.Message}");
            ShowStatus("Error saving notification settings.", Severity.Error);
        }
    }
    
    private async Task TestConnection()
    {
        if (string.IsNullOrEmpty(apiKey) || string.IsNullOrEmpty(secretKey))
        {
            ShowStatus("Please enter API key and secret key first.", Severity.Warning);
            return;
        }
        
        ShowStatus("Testing connection...", Severity.Info);
        
        // Simulate connection test
        await Task.Delay(2000);
        
        ShowStatus("Connection test completed successfully!", Severity.Success);
    }
    
    private void ClearSettings()
    {
        try
        {
            RemovePreference("binance_api_key");
            RemovePreference("binance_secret_key");
            RemovePreference("binance_testnet_url");
            RemovePreference("binance_environment");
            
            apiKey = string.Empty;
            secretKey = string.Empty;
            testnetUrl = string.Empty;
            environment = TradingEnvironment.Live;
            
            ShowStatus("API settings cleared successfully!", Severity.Info);
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error clearing settings: {ex.Message}");
            ShowStatus("Error clearing settings.", Severity.Error);
        }
    }
    
    private void ShowStatus(string message, Severity severity)
    {
        statusMessage = message;
        statusSeverity = severity;
        StateHasChanged();
        
        // Auto-hide status after 5 seconds
        _ = Task.Delay(5000).ContinueWith(_ =>
        {
            statusMessage = string.Empty;
            InvokeAsync(StateHasChanged);
        });
    }
}
